#!/bin/bash 

for cue in *.cue; do
	file="${cue%.*}.flac"
	if [ ! -f "$file" ]; then
		file="${cue%.*}.ape"
	fi
	if [ ! -f "$file" ]; then
		echo "Nor flac nor ape file found for cue $cue"
		continue
	fi
	
	echo "cue: $cue"
	echo "file: $file"

	cuebreakpoints "$cue" | shnsplit -o flac -O always "$file" || exit 1
	cuetag.sh "$cue" split-track*.flac || exit 1

	for i in {01..66}; do
		f="split-track$i.flac"
		if [ ! -f "$f" ]; then
			continue
		fi
		name=`cueprint -t '%P - %T - %02n %t' -n $i "$cue"`
		mv "$f" "$name.flac" || exit 1
	done
	
	del_dir="_DELETE"
	if [ ! -d "$del_dir" ]; then
		mkdir "$del_dir" || exit 1
	fi
	
	mv -n "$file" $del_dir	
done
